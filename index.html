import 'package:flutter/material.dart';
import 'dart:math';
import 'dart:html' as html;

void main() {
  runApp(const BingoApp());
}

class BingoApp extends StatelessWidget {
  const BingoApp({super.key});

  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      debugShowCheckedModeBanner: false,
      title: '·â¢·äï·åé ·å®·ãã·â≥',
      theme: ThemeData(
        useMaterial3: true,
        colorSchemeSeed: Colors.deepPurple,
        brightness: Brightness.light,
      ),
      home: const BingoAuthWrapper(),
    );
  }
}

class BingoAuthWrapper extends StatefulWidget {
  const BingoAuthWrapper({super.key});

  @override
  State<BingoAuthWrapper> createState() => _BingoAuthWrapperState();
}

class _BingoAuthWrapperState extends State<BingoAuthWrapper> {
  String? userName;

  @override
  void initState() {
    super.initState();
    userName = html.window.localStorage['bingo_user_name'];
  }

  void _saveUser(String name) {
    html.window.localStorage['bingo_user_name'] = name;
    setState(() {
      userName = name;
    });
  }

  @override
  Widget build(BuildContext context) {
    if (userName == null) {
      return RegistrationPage(onRegister: _saveUser);
    }
    return BingoGamePage(userName: userName!);
  }
}

class RegistrationPage extends StatelessWidget {
  final Function(String) onRegister;
  RegistrationPage({super.key, required this.onRegister});

  final TextEditingController _controller = TextEditingController();

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.white,
      body: Container(
        decoration: BoxDecoration(
          gradient: LinearGradient(
            colors: [Colors.deepPurple.shade100, Colors.white],
            begin: Alignment.topCenter,
            end: Alignment.bottomCenter,
          ),
        ),
        child: Center(
          child: Card(
            elevation: 10,
            shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(20)),
            child: Padding(
              padding: const EdgeInsets.all(40.0),
              child: Column(
                mainAxisSize: MainAxisSize.min,
                children: [
                  const Icon(Icons.casino, size: 80, color: Colors.deepPurple),
                  const SizedBox(height: 20),
                  const Text(
                    "·ä•·äï·ä≥·äï ·ãà·ã∞ ·â¢·äï·åé ·àò·å°", 
                    style: TextStyle(fontSize: 28, fontWeight: FontWeight.bold, color: Colors.deepPurple)
                  ),
                  const SizedBox(height: 30),
                  SizedBox(
                    width: 300,
                    child: TextField(
                      controller: _controller,
                      decoration: InputDecoration(
                        labelText: "·àµ·àù·ãé·äï ·ã´·àµ·åà·â°",
                        prefixIcon: const Icon(Icons.face),
                        border: OutlineInputBorder(borderRadius: BorderRadius.circular(15)),
                        filled: true,
                        fillColor: Colors.grey.shade50,
                      ),
                    ),
                  ),
                  const SizedBox(height: 30),
                  ElevatedButton(
                    onPressed: () {
                      if (_controller.text.trim().isNotEmpty) {
                        onRegister(_controller.text.trim());
                      }
                    },
                    style: ElevatedButton.styleFrom(
                      padding: const EdgeInsets.symmetric(horizontal: 60, vertical: 18),
                      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(15)),
                      backgroundColor: Colors.deepPurple,
                      foregroundColor: Colors.white,
                    ),
                    child: const Text("·ã≠·àò·ãù·åà·â°", style: TextStyle(fontSize: 18)),
                  )
                ],
              ),
            ),
          ),
        ),
      ),
    );
  }
}

class BingoCell {
  final int number;
  bool isMarked;
  final bool isFreeSpace;
  BingoCell({required this.number, this.isMarked = false, this.isFreeSpace = false});
}

class BingoGamePage extends StatefulWidget {
  final String userName;
  const BingoGamePage({super.key, required this.userName});

  @override
  State<BingoGamePage> createState() => _BingoGamePageState();
}

class _BingoGamePageState extends State<BingoGamePage> {
  List<BingoCell> board = [];
  List<int> drawnNumbers = [];
  int? currentNumber;
  bool hasWon = false;

  @override
  void initState() {
    super.initState();
    _generateBoard();
  }

  void _generateBoard() {
    setState(() {
      board.clear();
      drawnNumbers.clear();
      currentNumber = null;
      hasWon = false;
      
      List<int> b = _rand(1, 15, 5);
      List<int> i = _rand(16, 30, 5);
      List<int> n = _rand(31, 45, 4);
      List<int> g = _rand(46, 60, 5);
      List<int> o = _rand(61, 75, 5);

      for (int r = 0; r < 5; r++) {
        board.add(BingoCell(number: b[r]));
        board.add(BingoCell(number: i[r]));
        if (r == 2) {
          board.add(BingoCell(number: 0, isMarked: true, isFreeSpace: true));
        } else {
          board.add(BingoCell(number: r < 2 ? n[r] : n[r - 1]));
        }
        board.add(BingoCell(number: g[r]));
        board.add(BingoCell(number: o[r]));
      }
    });
  }

  List<int> _rand(int min, int max, int count) {
    Set<int> nums = {};
    while (nums.length < count) {
      nums.add(min + Random().nextInt(max - min + 1));
    }
    var list = nums.toList();
    list.sort();
    return list;
  }

  void _draw() {
    if (hasWon || drawnNumbers.length >= 75) return;
    int next;
    do { 
      next = 1 + Random().nextInt(75); 
    } while (drawnNumbers.contains(next));

    setState(() {
      currentNumber = next;
      drawnNumbers.add(next);
      for (var c in board) { 
        if (c.number == next) c.isMarked = true; 
      }
      _checkWin();
    });
  }

  void _checkWin() {
    bool win = false;
    for (int i = 0; i < 5; i++) {
      if (board.skip(i * 5).take(5).every((c) => c.isMarked)) win = true;
      if ([0, 5, 10, 15, 20].every((j) => board[i + j].isMarked)) win = true;
    }
    if ([0, 6, 12, 18, 24].every((i) => board[i].isMarked)) win = true;
    if ([4, 8, 12, 16, 20].every((i) => board[i].isMarked)) win = true;
    if (board[0].isMarked && board[4].isMarked && board[20].isMarked && board[24].isMarked) win = true;

    if (win) {
      setState(() => hasWon = true);
      _showWinDialog();
    }
  }

  void _showWinDialog() {
    showDialog(
      context: context, 
      barrierDismissible: false,
      builder: (_) => AlertDialog(
        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(20)),
        title: const Center(child: Text("üéâ ·â¢·äï·åé! üéâ", style: TextStyle(color: Colors.green, fontSize: 30, fontWeight: FontWeight.bold))),
        content: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            const Icon(Icons.emoji_events, size: 80, color: Colors.amber),
            const SizedBox(height: 10),
            Text("·ä•·äï·ä≥·äï ·ã∞·àµ ·ä†·àà·ãé·âµ ${widget.userName}!", textAlign: TextAlign.center, style: const TextStyle(fontSize: 20)),
            const Text("·ä†·à∏·äì·çä ·àÜ·äê·ãã·àç!", style: TextStyle(fontWeight: FontWeight.bold)),
          ],
        ),
        actions: [
          Center(
            child: ElevatedButton(
              onPressed: () { Navigator.pop(context); _generateBoard(); }, 
              style: ElevatedButton.styleFrom(backgroundColor: Colors.green, foregroundColor: Colors.white),
              child: const Text("·ä•·äï·ã∞·åà·äì ·ã≠·å´·ãà·â±"),
            ),
          )
        ],
      )
    );
  }

  void _showRules() {
    showDialog(
      context: context,
      builder: (_) => AlertDialog(
        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(20)),
        title: const Row(
          children: [Icon(Icons.rule, color: Colors.deepPurple), SizedBox(width: 10), Text("·ã®·â¢·äï·åé ·ã∞·äï·â•")],
        ),
        content: const Column(
          mainAxisSize: MainAxisSize.min,
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Text("·àõ·à∏·äê·çç ·ã®·àö·âª·àà·ãç ·ã®·àö·ä®·â∞·àâ·âµ ·à≤·àü·àâ ·äê·ãç·ç¶", style: TextStyle(fontWeight: FontWeight.bold)),
            Divider(),
            ListTile(leading: Icon(Icons.linear_scale, size: 20), title: Text("·â†·ä†·åç·ãµ·àù ·ãà·ã≠·àù ·â†·âÅ·àç·âÅ·àç ·àò·àµ·àò·à≠")),
            ListTile(leading: Icon(Icons.diagonal_arrow_right_up, size: 20), title: Text("·â†·à∞·ã´·çç (Diagonal) ·àò·àµ·àò·à≠")),
            ListTile(leading: Icon(Icons.grid_view, size: 20), title: Text("·â†·ä†·à´·â±·àù ·å´·çé·âΩ ·àõ·åç·äò·âµ")),
          ],
        ),
        actions: [TextButton(onPressed: () => Navigator.pop(context), child: const Text("·ä•·à∫"))],
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.grey.shade100,
      appBar: AppBar(
        title: Text("·â¢·äï·åé ·å®·ãã·â≥ - ${widget.userName}"),
        actions: [
          IconButton(onPressed: _showRules, icon: const Icon(Icons.info_outline)),
        ],
        backgroundColor: Colors.deepPurple,
        foregroundColor: Colors.white,
        elevation: 0,
      ),
      body: Column(
        children: [
          Container(
            padding: const EdgeInsets.symmetric(vertical: 20, horizontal: 15),
            decoration: BoxDecoration(
              color: Colors.deepPurple,
              borderRadius: const BorderRadius.only(bottomLeft: Radius.circular(30), bottomRight: Radius.circular(30)),
              boxShadow: [BoxShadow(color: Colors.black.withOpacity(0.1), blurRadius: 10, offset: const Offset(0, 5))],
            ),
            child: Column(
              children: [
                AnimatedSwitcher(
                  duration: const Duration(milliseconds: 300),
                  child: Text(
                    currentNumber == null ? "·àà·àò·åÄ·àò·à≠ ·ãù·åç·åÅ ·äñ·âµ?" : "·ã®·â∞·å†·à´·ãç ·âÅ·å•·à≠·ç¶ $currentNumber", 
                    key: ValueKey(currentNumber),
                    style: const TextStyle(fontSize: 26, fontWeight: FontWeight.bold, color: Colors.white)
                  ),
                ),
                const SizedBox(height: 5),
                Text("·ã®·â∞·å†·à© ·âÅ·å•·àÆ·âΩ ·â•·ãõ·âµ·ç¶ ${drawnNumbers.length}", style: const TextStyle(color: Colors.white70)),
              ],
            ),
          ),
          const SizedBox(height: 10),
          Expanded(
            child: Padding(
              padding: const EdgeInsets.all(12), 
              child: AspectRatio(
                aspectRatio: 1,
                child: GridView.builder(
                  gridDelegate: const SliverGridDelegateWithFixedCrossAxisCount(
                    crossAxisCount: 5, 
                    crossAxisSpacing: 8, 
                    mainAxisSpacing: 8
                  ),
                  itemCount: 25, 
                  itemBuilder: (_, i) {
                    bool isSelected = board[i].isMarked;
                    return AnimatedContainer(
                      duration: const Duration(milliseconds: 200),
                      decoration: BoxDecoration(
                        color: isSelected ? Colors.green.shade400 : Colors.white, 
                        border: Border.all(color: isSelected ? Colors.green : Colors.deepPurple.shade100, width: 2), 
                        borderRadius: BorderRadius.circular(12),
                        boxShadow: [
                          if (!isSelected) const BoxShadow(color: Colors.black12, blurRadius: 4, offset: Offset(0, 2))
                        ]
                      ),
                      child: Center(
                        child: board[i].isFreeSpace 
                          ? const Icon(Icons.star, color: Colors.orange, size: 35) 
                          : Text(
                              "${board[i].number}", 
                              style: TextStyle(
                                fontSize: 20, 
                                color: isSelected ? Colors.white : Colors.black87, 
                                fontWeight: FontWeight.bold
                              )
                            ),
                      ),
                    );
                  },
                ),
              ),
            )
          ),
          Container(
            padding: const EdgeInsets.all(25),
            decoration: const BoxDecoration(
              color: Colors.white,
              borderRadius: BorderRadius.only(topLeft: Radius.circular(30), topRight: Radius.circular(30)),
            ),
            child: Row(
              children: [
                Expanded(
                  child: ElevatedButton.icon(
                    onPressed: hasWon ? null : _draw, 
                    icon: const Icon(Icons.play_arrow),
                    label: const Text("·âÅ·å•·à≠ ·å•·à´", style: TextStyle(fontSize: 20)),
                    style: ElevatedButton.styleFrom(
                      backgroundColor: Colors.deepPurple,
                      foregroundColor: Colors.white,
                      padding: const EdgeInsets.symmetric(vertical: 18),
                      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(15)),
                    ),
                  )
                ),
                const SizedBox(width: 15),
                IconButton(
                  onPressed: _generateBoard, 
                  icon: const Icon(Icons.refresh, color: Colors.redAccent),
                  style: IconButton.styleFrom(
                    backgroundColor: Colors.red.shade50,
                    padding: const EdgeInsets.all(15),
                  ),
                ),
              ],
            )
          )
        ],
      ),
    );
  }
}
