import 'package:flutter/material.dart';
import 'dart:math';
import 'dart:html' as html; // ለዳርትፓድ LocalStorage ለመጠቀም

void main() {
  runApp(const BingoApp());
}

class BingoApp extends StatelessWidget {
  const BingoApp({super.key});

  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      debugShowCheckedModeBanner: false,
      theme: ThemeData(
        useMaterial3: true,
        colorSchemeSeed: Colors.indigo,
      ),
      home: const BingoAuthWrapper(),
    );
  }
}

// የተጠቃሚ ምዝገባን የሚቆጣጠር ክፍል
class BingoAuthWrapper extends StatefulWidget {
  const BingoAuthWrapper({super.key});

  @override
  State<BingoAuthWrapper> createState() => _BingoAuthWrapperState();
}

class _BingoAuthWrapperState extends State<BingoAuthWrapper> {
  String? userName;

  @override
  void initState() {
    super.initState();
    // የተቀመጠ ስም ካለ መፈተሽ (Persistence logic)
    userName = html.window.localStorage['bingo_user_name'];
  }

  void _saveUser(String name) {
    html.window.localStorage['bingo_user_name'] = name;
    setState(() {
      userName = name;
    });
  }

  @override
  Widget build(BuildContext context) {
    if (userName == null) {
      return RegistrationPage(onRegister: _saveUser);
    }
    return BingoGamePage(userName: userName!);
  }
}

// የምዝገባ ገጽ
class RegistrationPage extends StatelessWidget {
  final Function(String) onRegister;
  RegistrationPage({super.key, required this.onRegister});

  final TextEditingController _controller = TextEditingController();

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: Center(
        child: Padding(
          padding: const EdgeInsets.all(30.0),
          child: Column(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [
              const Text("እንኳን ወደ ቢንጎ ጨዋታ መጡ", style: TextStyle(fontSize: 22, fontWeight: FontWeight.bold)),
              const SizedBox(height: 20),
              TextField(
                controller: _controller,
                decoration: const InputDecoration(
                  labelText: "ስምዎን ያስገቡ",
                  border: OutlineInputBorder(),
                ),
              ),
              const SizedBox(height: 20),
              ElevatedButton(
                onPressed: () {
                  if (_controller.text.isNotEmpty) {
                    onRegister(_controller.text);
                  }
                },
                child: const Text("ይመዝገቡ"),
              )
            ],
          ),
        ),
      ),
    );
  }
}

class BingoCell {
  final int number;
  bool isMarked;
  final bool isFreeSpace;
  BingoCell({required this.number, this.isMarked = false, this.isFreeSpace = false});
}

class BingoGamePage extends StatefulWidget {
  final String userName;
  const BingoGamePage({super.key, required this.userName});

  @override
  State<BingoGamePage> createState() => _BingoGamePageState();
}

class _BingoGamePageState extends State<BingoGamePage> {
  List<BingoCell> board = [];
  List<int> drawnNumbers = [];
  int? currentNumber;
  bool hasWon = false;

  @override
  void initState() {
    super.initState();
    _generateBoard();
  }

  void _generateBoard() {
    setState(() {
      board.clear();
      drawnNumbers.clear();
      currentNumber = null;
      hasWon = false;
      List<int> b = _rand(1, 15, 5);
      List<int> i = _rand(16, 30, 5);
      List<int> n = _rand(31, 45, 4);
      List<int> g = _rand(46, 60, 5);
      List<int> o = _rand(61, 75, 5);
      for (int r = 0; r < 5; r++) {
        board.add(BingoCell(number: b[r]));
        board.add(BingoCell(number: i[r]));
        if (r == 2) {
          board.add(BingoCell(number: 0, isMarked: true, isFreeSpace: true));
        } else {
          board.add(BingoCell(number: r < 2 ? n[r] : n[r - 1]));
        }
        board.add(BingoCell(number: g[r]));
        board.add(BingoCell(number: o[r]));
      }
    });
  }

  List<int> _rand(int min, int max, int count) {
    Set<int> nums = {};
    while (nums.length < count) nums.add(min + Random().nextInt(max - min + 1));
    return nums.toList();
  }

  void _draw() {
    if (hasWon || drawnNumbers.length >= 75) return;
    int next;
    do { next = 1 + Random().nextInt(75); } while (drawnNumbers.contains(next));
    setState(() {
      currentNumber = next;
      drawnNumbers.add(next);
      for (var c in board) { if (c.number == next) c.isMarked = true; }
      _check();
    });
  }

  void _check() {
    // 1. ረድፎችን እና አምዶችን መፈተሽ
    for (int i = 0; i < 5; i++) {
      if (board.skip(i * 5).take(5).every((c) => c.isMarked)) _win(); // Row
      if ([0, 5, 10, 15, 20].every((j) => board[i + j].isMarked)) _win(); // Col
    }
    // 2. ዲያጎናል (Diagonal) መፈተሽ
    if ([0, 6, 12, 18, 24].every((i) => board[i].isMarked)) _win();
    if ([4, 8, 12, 16, 20].every((i) => board[i].isMarked)) _win();
    
    // 3. አራት ማዕዘኖች (Four Corners) መፈተሽ
    if (board[0].isMarked && board[4].isMarked && board[20].isMarked && board[24].isMarked) _win();
  }

  void _win() {
    if (hasWon) return;
    setState(() => hasWon = true);
    showDialog(context: context, builder: (_) => AlertDialog(
      title: const Text("ቢንጎ!"),
      content: Text("እንኳን ደስ አለዎት ${widget.userName}! አሸንፈዋል!"),
      actions: [TextButton(onPressed: () { Navigator.pop(context); _generateBoard(); }, child: const Text("እንደገና"))],
    ));
  }

  void _showRules() {
    showDialog(
      context: context,
      builder: (_) => AlertDialog(
        title: const Text("የጨዋታ ደንብ"),
        content: const Text(
          "ማሸነፍ የሚቻለው የሚከተሉት ሲሟሉ ነው፡\n\n"
          "1. በአግድም ወይም በቁልቁል ቀጥ ያለ መስመር መስራት ሲቻል\n"
          "2. በዲያጎናል (ከማዕዘን እስከ ማዕዘን) መስመር መስራት ሲቻል\n"
          "3. በሰንጠረዡ አራቱም ጫፎች ላይ ያሉትን ቁጥሮች ማግኘት ሲቻል"
        ),
        actions: [TextButton(onPressed: () => Navigator.pop(context), child: const Text("እሺ"))],
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: Text("ተጫዋች: ${widget.userName}"),
        actions: [
          IconButton(onPressed: _showRules, icon: const Icon(Icons.info_outline)),
          TextButton(onPressed: _showRules, child: const Text("የጨዋታ ደንብ", style: TextStyle(color: Colors.white))),
        ],
        backgroundColor: Colors.indigo,
        foregroundColor: Colors.white,
      ),
      body: Column(children: [
        Container(width: double.infinity, padding: const EdgeInsets.all(20), color: Colors.indigo.shade50,
          child: Column(children: [
            Text(currentNumber == null ? "ለመጀመር ቁልፉን ይጫኑ" : "የተጠራው፡ $currentNumber", style: const TextStyle(fontSize: 24, fontWeight: FontWeight.bold)),
            Text("የተጠሩ ቁጥሮች ብዛት፡ ${drawnNumbers.length}"),
          ])),
        Expanded(child: Padding(padding: const EdgeInsets.all(10), child: GridView.builder(
          gridDelegate: const SliverGridDelegateWithFixedCrossAxisCount(crossAxisCount: 5, crossAxisSpacing: 5, mainAxisSpacing: 5),
          itemCount: 25, itemBuilder: (_, i) => Container(
            decoration: BoxDecoration(color: board[i].isMarked ? Colors.green : Colors.white, border: Border.all(color: Colors.indigo), borderRadius: BorderRadius.circular(5)),
            child: Center(child: board[i].isFreeSpace ? const Icon(Icons.star, color: Colors.orange) : Text("${board[i].number}", style: TextStyle(color: board[i].isMarked ? Colors.white : Colors.black, fontWeight: FontWeight.bold))),
          )))),
        Padding(padding: const EdgeInsets.all(20), child: Row(children: [
          Expanded(child: ElevatedButton(onPressed: hasWon ? null : _draw, child: const Text("ቁጥር ጥራ"))),
          const SizedBox(width: 10),
          ElevatedButton(onPressed: _generateBoard, child: const Text("እንደገና")),
        ]))
      ]),
    );
  }
}
