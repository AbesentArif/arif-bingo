import 'package:flutter/material.dart';
import 'dart:math';
import 'dart:html' as html; // ·àà LocalStorage ·àò·å†·âÄ·àù·ã´

void main() {
  runApp(const BingoApp());
}

class BingoApp extends StatelessWidget {
  const BingoApp({super.key});

  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      debugShowCheckedModeBanner: false,
      theme: ThemeData(primarySwatch: Colors.blue),
      home: const BingoGame(),
    );
  }
}

class BingoGame extends StatefulWidget {
  const BingoGame({super.key});

  @override
  _BingoGameState createState() => _BingoGameState();
}

class _BingoGameState extends State<BingoGame> {
  List<int> board = [];
  List<bool> selected = List.generate(25, (index) => false);
  bool hasWon = false;
  String? userName;
  final TextEditingController _nameController = TextEditingController();

  @override
  void initState() {
    super.initState();
    _loadUser(); // ·ã®·â∞·âÄ·àò·å† ·àµ·àù ·ä´·àà ·àò·çà·â∞·àΩ
    _generateBoard();
  }

  // ·àµ·àù·äï ·ä® LocalStorage ·àò·å´·äõ
  void _loadUser() {
    final savedName = html.window.localStorage['bingo_user_name'];
    if (savedName != null && savedName.isNotEmpty) {
      setState(() {
        userName = savedName;
      });
    }
  }

  // ·àµ·àù·äï ·â† LocalStorage ·àõ·àµ·âÄ·àò·å´
  void _saveUser(String name) {
    if (name.isNotEmpty) {
      html.window.localStorage['bingo_user_name'] = name;
      setState(() {
        userName = name;
      });
    }
  }

  void _generateBoard() {
    List<int> numbers = List.generate(75, (index) => index + 1);
    numbers.shuffle();
    setState(() {
      board = numbers.take(25).toList();
      selected = List.generate(25, (index) => false);
      selected[12] = true; // ·àò·ä´·ä®·àà·äõ·ãã ·äê·åª (Free) ·äê·âΩ
      hasWon = false;
    });
  }

  void _toggleCell(int index) {
    if (hasWon) return;
    setState(() {
      selected[index] = !selected[index];
      _checkWin();
    });
  }

  void _checkWin() {
    // ·ä†·åç·ãµ·àù (Rows)
    for (int i = 0; i < 25; i += 5) {
      if (selected[i] && selected[i + 1] && selected[i + 2] && selected[i + 3] && selected[i + 4]) {
        hasWon = true;
      }
    }
    // ·âÅ·àç·âÅ·àç (Columns)
    for (int i = 0; i < 5; i++) {
      if (selected[i] && selected[i + 5] && selected[i + 10] && selected[i + 15] && selected[i + 20]) {
        hasWon = true;
      }
    }
    // ·à∞·ã´·çç (Diagonals)
    if (selected[0] && selected[6] && selected[12] && selected[18] && selected[24]) hasWon = true;
    if (selected[4] && selected[8] && selected[12] && selected[16] && selected[20]) hasWon = true;

    // ·ä†·à´·â± ·àõ·ãï·ãò·äñ·âΩ (Four Corners) - ·ä†·ã≤·àµ ·ã®·â∞·å®·àò·à®
    if (selected[0] && selected[4] && selected[20] && selected[24]) hasWon = true;
  }

  void _showRules() {
    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        title: const Text("·ã®·å®·ãã·â≥ ·ã∞·äï·â•"),
        content: const Text(
            "‚Ä¢ ·â†·ä†·åç·ãµ·àù ·ãà·ã≠·àù ·â†·âÅ·àç·âÅ·àç 5 ·àò·àµ·àò·à≠ ·àò·àô·àã·âµ·ç¢\n"
            "‚Ä¢ ·â†·à∞·ã´·çç (Diagonal) 5 ·àò·àµ·àò·à≠ ·àò·àô·àã·âµ·ç¢\n"
            "‚Ä¢ ·ä†·à´·â±·äï·àù ·ã®·â¶·à≠·ã± ·àõ·ãï·ãò·äñ·âΩ (Corners) ·àò·àô·àã·âµ·ç¢\n\n"
            "·ä®·ä•·äê·ãö·àÖ ·ä†·äï·ã±·äï ·à≤·ã´·àü·àâ '·â¢·äï·åé!' ·ã≠·â£·àã·àç·ç¢"),
        actions: [
          TextButton(onPressed: () => Navigator.pop(context), child: const Text("·åà·â£·äù"))
        ],
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    // ·àµ·àù ·ä´·àç·â∞·àò·ãò·åà·â† ·ã®·àù·ãù·åà·â£ ·åà·åΩ ·ä†·à≥·ã≠
    if (userName == null) {
      return Scaffold(
        body: Center(
          child: Padding(
            padding: const EdgeInsets.all(20.0),
            child: Column(
              mainAxisAlignment: MainAxisAlignment.center,
              children: [
                const Text("·ä•·äï·ä≥·äï ·ãà·ã∞ ·â¢·äï·åé ·å®·ãã·â≥ ·â†·ã∞·àÖ·äì ·àò·å°!", style: TextStyle(fontSize: 20, fontWeight: FontWeight.bold)),
                const SizedBox(height: 20),
                TextField(
                  controller: _nameController,
                  decoration: const InputDecoration(labelText: "·àµ·àù·ãé·äï ·ã´·àµ·åà·â°", border: OutlineInputBorder()),
                ),
                const SizedBox(height: 20),
                ElevatedButton(
                  onPressed: () => _saveUser(_nameController.text),
                  child: const Text("·å®·ãã·â≥·ãç·äï ·åÄ·àù·à≠"),
                )
              ],
            ),
          ),
        ),
      );
    }

    // ·ãã·äì·ãç ·ã®·å®·ãã·â≥ ·åà·åΩ
    return Scaffold(
      appBar: AppBar(
        title: Text("·ã®·â¢·äï·åé ·å®·ãã·â≥ - ·à∞·àã·àù $userName"),
        actions: [
          IconButton(
            icon: const Icon(Icons.help_outline),
            tooltip: "·ã®·å®·ãã·â≥ ·ã∞·äï·â•",
            onPressed: _showRules,
          )
        ],
      ),
      body: Column(
        children: [
          const SizedBox(height: 10),
          if (hasWon)
            const Text("üéâ ·â¢·äï·åé! ·ä†·à∏·äï·çà·ãã·àç! üéâ", style: TextStyle(fontSize: 24, fontWeight: FontWeight.bold, color: Colors.green)),
          Expanded(
            child: Padding(
              padding: const EdgeInsets.all(8.0),
              child: GridView.builder(
                gridDelegate: const SliverGridDelegateWithFixedCrossAxisCount(crossAxisCount: 5),
                itemCount: 25,
                itemBuilder: (context, index) {
                  bool isFree = index == 12;
                  return GestureDetector(
                    onTap: () => _toggleCell(index),
                    child: Container(
                      margin: const EdgeInsets.all(2),
                      decoration: BoxDecoration(
                        color: selected[index] ? Colors.orange : Colors.blue[100],
                        border: Border.all(color: Colors.blue),
                        borderRadius: BorderRadius.circular(8),
                      ),
                      child: Center(
                        child: Text(
                          isFree ? "FREE" : "${board[index]}",
                          style: TextStyle(
                            fontSize: 18,
                            fontWeight: FontWeight.bold,
                            color: selected[index] ? Colors.white : Colors.black,
                          ),
                        ),
                      ),
                    ),
                  );
                },
              ),
            ),
          ),
          Padding(
            padding: const EdgeInsets.only(bottom: 20.0),
            child: ElevatedButton(
              onPressed: _generateBoard,
              child: const Text("·ä†·ã≤·àµ ·å®·ãã·â≥ ·åÄ·àù·à≠"),
            ),
          ),
        ],
      ),
    );
  }
}
